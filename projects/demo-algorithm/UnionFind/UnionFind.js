/**
 * å¹¶æŸ¥é›†ä¸“ç”¨ç»“ç‚¹
 * @param {V} v ç”¨æˆ·ç»™çš„æ ·æœ¬
 * @constructor
 */
function Node(v) {
  this.value = v;
}

/**
 * å¹¶æŸ¥é›†
 * è¿™æ˜¯ä¸ªç¥å™¨ğŸ†ï¼Œèƒ½è§£å†³ä¸€å¤§ç‰‡çš„é—®é¢˜! ä½ è¢«ç«è½¦ğŸš„æ’äº†éƒ½ä¸èƒ½å¿˜çš„!!
 *
 * ä¸¤ä¸ªä¼˜åŒ–:
 * 1. å°é›†åˆå»æŒ‚å¤§é›†åˆ
 * 2. æ¯æŸ¥è¯¢ä¸€æ¬¡ head, éƒ½æŠŠ cur åˆ° head çš„æ¯ä¸€ä¸ªæ²¿é€”ç»“ç‚¹æŒ‚åˆ° head ä¸Š
 *
 * è¿™ä¸¤ä¸ªä¼˜åŒ–çš„ç›®çš„ï¼Œéƒ½æ˜¯æŠŠ`é“¾`å˜å¾—æ‰å¹³åŒ–ã€‚
 */
class UnionSet {
  // åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç”¨æˆ·æŠŠæ‰€æœ‰æ ·æœ¬çš„åˆ—è¡¨ä¸€è‚¡è„‘åœ°ç»™æˆ‘
  // Array<V> values
  constructor(values) {
    // Map<V,Node<V>>  `æ ·æœ¬->ç»“ç‚¹`å¯¹åº”è¡¨, ä»£è¡¨:ç”¨æˆ·æ•°æ®->UnionSetåŒ…è£…åçš„ç»“ç‚¹ã€‚å¦‚ a->aåœˆ, b->båœˆã€‚
    this.nodes = new Map();
    // Map<Node<V>,Node<V>>  `ç»“ç‚¹->çˆ¶ç»“ç‚¹`å¯¹åº”è¡¨ã€‚
    this.parents = new Map();
    // Map<Node<V>,number> ç»“ç‚¹ä»£è¡¨çš„é›†åˆçš„å¤§å°, åªæœ‰é›†åˆçš„ä»£è¡¨ç»“ç‚¹ï¼Œä¼šåœ¨ sizeMap é‡Œç•™ä¸‹è®°å½•ã€‚
    this.sizeMap = new Map();
    // æ¯ä¸ªå…ƒç´ ç”Ÿæˆ UnionSet ä¸“ç”¨çš„ Node ç»“æ„
    for (let i = 0, len = values.length; i < len; i++) {
      const node = new Node(values[i]);
      // `ç”¨æˆ·æ ·æœ¬`å¯¹åº”`å¹¶æŸ¥é›†ç»“ç‚¹`
      this.nodes.set(values[i], node);
      // ç»“ç‚¹åˆå§‹åŒ–å¯¹åº”çš„çˆ¶ç»“ç‚¹æ˜¯è‡ªå·±
      this.parents.set(node, node);
      // æ¯ä¸ªç»“ç‚¹éƒ½æ˜¯è‡ªå·±çš„ä»£è¡¨ç»“ç‚¹ï¼Œè‡ªå·±æˆä¸€ä¸ªå°é›†åˆ
      this.sizeMap.set(node, 1);
    }
  }
  
  /**
   * å†…éƒ¨ä½¿ç”¨
   *
   * ç»™å®šä¸€ä¸ªç»“ç‚¹ï¼Œè¯·ä½ å¾€ä¸Šåˆ°ä¸èƒ½å†å¾€ä¸Šï¼ŒæŠŠ`ä»£è¡¨ç»“ç‚¹`è¿”å›ã€‚
   *
   * æ—¶é—´å¤æ‚åº¦
   * æœ¬æ–¹æ³•è°ƒç”¨ä¼šéå¸¸é¢‘ç¹ï¼Œå½“è°ƒç”¨æ¬¡æ•°åˆ°è¾¾ N çš„è§„æ¨¡ä»¥åï¼Œå•æ¬¡æŸ¥è¯¢çš„é€Ÿåº¦å°±æ˜¯ O(1)ã€‚
   *
   * é‡è¦ä¼˜åŒ–ğŸ”¥
   * æ¯æ¬¡æŸ¥è¯¢ï¼Œéƒ½è®© cur åˆ° head çš„æ²¿é€”ç»“ç‚¹ç›´æ¥è¿ä¸Š head, ä½¿å¾— cur åˆ° head çš„è¿™æ¡é“¾å˜å¾—æ‰å¹³ã€‚
   * å¦‚ cur->a->b->head, å˜ä¸º cur->head, a->head, b->head, head->headã€‚
   * ä»¥åè¿™æ¡é“¾ä¸Šçš„ç»“ç‚¹å†æŸ¥è¯¢ï¼Œå°±ä¸€æ­¥åˆ°ä½äº†ï¼Œæ€§èƒ½æå‡ã€‚
   *
   * åŸæ¥çš„ç»“æ„:
   *         z
   *       y
   *     x
   *   a
   *     b
   *       c
   *
   * è°ƒç”¨ä¸€æ¬¡ _findHead(a) ä¹‹åï¼Œç»“æ„å°±å˜æˆ:
   *
   *         z
   *   a     x    y
   *     b
   *       c
   *
   * æ²¿é€”çš„ç»“ç‚¹ a->x->y->z ç›´æ¥è¿åˆ° z ä¸Š, a->z, x->z, y->zï¼Œæ‰å¹³åŒ–äº†ã€‚
   *
   * @param {Node<V>>} cur
   * @return {Node<V>} ä»£è¡¨ç»“ç‚¹ headï¼Œä¹Ÿå°±æ˜¯ cur é›†åˆçš„å¤´
   */
  _findHead(cur) {
    // ä¿å­˜ä» cur åˆ° head çš„æ‰€æœ‰ç»“ç‚¹ï¼Œå¦‚ cur->a->b->headï¼Œä¿å­˜çš„æ˜¯ [cur,a,b,head]ã€‚
    const path = [];  // Stack
    // cur ä¸€è·¯å¾€ä¸Šçªœ
    while (cur !== this.parents.get(cur)) {
      // `curä¸ç­‰äºçˆ¶`å°±æ˜¯æ²¡åˆ°é¡¶ï¼Œç»§ç»­
      // æ²¿é€”ç»“ç‚¹éƒ½æ”¾åˆ°æ ˆé‡Œ
      path.push(cur);
      // cur å¾€ä¸Š
      cur = this.parents.get(cur);
    }
    // ä¾æ¬¡å¼¹å‡ºæ ˆçš„ç»“ç‚¹ï¼Œæ¯ä¸ªç»“ç‚¹éƒ½è¿ä¸Š head
    while (path.length > 0) {
      const pop = path.pop();
      this.parents.set(pop, cur);
    }
    // è¿”å› head
    return cur;
  }
  
  /**
   * æŸ¥è¯¢ a æ ·æœ¬å’Œ b æ ·æœ¬åœ¨ä¸åœ¨åŒä¸€ä¸ªé›†åˆé‡Œ
   *
   * @param {V} a ç”¨æˆ·ä¼ å…¥çš„æ ·æœ¬a
   * @param {V} b ç”¨æˆ·ä¼ å…¥çš„æ ·æœ¬b
   */
  isSameSet(a, b) {
    // åˆ¤æ–­ä»£è¡¨ç»“ç‚¹æ˜¯ä¸æ˜¯åŒä¸€ä¸ªå³å¯
    return this._findHead(this.nodes.get(a)) === this._findHead(this.nodes.get(b));
  }
  
  /**
   * æŠŠ aæ‰€åœ¨çš„é›†åˆ å’Œ bæ‰€åœ¨çš„é›†åˆ åˆæˆä¸€ä¸ªé›†åˆ
   * @param {V} a ç”¨æˆ·ä¼ å…¥çš„æ ·æœ¬a
   * @param {V} b ç”¨æˆ·ä¼ å…¥çš„æ ·æœ¬b
   */
  union(a, b) {
    // æ‹¿åˆ° a çš„ä»£è¡¨ç»“ç‚¹
    const aHead = this._findHead(this.nodes.get(a));
    // æ‹¿åˆ° b çš„ä»£è¡¨ç»“ç‚¹
    const bHead = this._findHead(this.nodes.get(b));
    // å¦‚æœ aHead === bHead, é‚£å°±è¯´æ˜ a,b å·²ç»æ˜¯åŒä¸€ä¸ªé›†åˆäº†ï¼Œä¸ç”¨åšä»»ä½•äº‹ã€‚
    // åªæœ‰å®ƒä»¬ä¸åŒçš„æ—¶å€™ï¼Œæ‰éœ€è¦åˆå¹¶ã€‚
    if (aHead !== bHead) {
      // aæ‰€åœ¨é›†åˆçš„å¤§å°
      const aSetSize = this.sizeMap.get(aHead);
      // bæ‰€åœ¨é›†åˆçš„å¤§å°
      const bSetSize = this.sizeMap.get(bHead);
      // æ‹¿åˆ°è¾ƒå¤§çš„é‚£ä¸ªé›†åˆçš„ä»£è¡¨ç»“ç‚¹
      const big = aSetSize >= bSetSize ? aHead : bHead;
      // æŠ“ä¸€ä¸‹è¾ƒå°çš„
      const small = big === aHead ? bHead : aHead;
      // `å°é›†åˆçš„å¤´`æŒ‡å‘`å¤§é›†åˆçš„å¤´`ï¼Œå«ä¹‰æ˜¯: å°é›†åˆåˆå¹¶åˆ°å¤§é›†åˆé‡Œå»äº†ã€‚
      // è¿™æ˜¯ä¸€ä¸ªé‡è¦ä¼˜åŒ–ğŸ”¥
      this.parents.set(small, big);
      // æ›´æ–°é›†åˆå¤§å°
      this.sizeMap.set(big, aSetSize + bSetSize);
      // sizeMap åªç»´æŠ¤ä»£è¡¨ç»“ç‚¹ï¼Œå°é›†åˆå·²ç»å¹¶å…¥å¤§é›†åˆäº†ï¼Œå°ä»£è¡¨ç»“ç‚¹ä¸å­˜åœ¨äº†ï¼Œç§»é™¤è®°å½•
      this.sizeMap.delete(small);
    }
  }
}
