/**
 * åŠ›æ‰£305. å²›å±¿æ•°é‡ II
 * https://leetcode.cn/problems/number-of-islands-ii/description/
 *
 * æŠ€å·§:
 * åŠ¨æ€åŠ 1ï¼ŒåŠ¨æ€åˆå§‹åŒ–
 *
 * æ—¶é—´å¤æ‚åº¦:
 *  1. çŸ©é˜µæ˜¯ m*n çš„ï¼Œåˆå§‹åŒ–å¹¶æŸ¥é›†éœ€è¦ä¸€ä¸ª O(m*n) çš„è¿‡ç¨‹ã€‚
 *  2. å¦‚æœæˆ‘ç©ºé™ k ä¸ª`1`, æ¯ä¸ª`1`éƒ½è·Ÿè‡ªå·±`ä¸Šä¸‹å·¦å³`è¿ä¸€ä¸‹ï¼Œè¿çš„è¿‡ç¨‹åœ¨å¹¶æŸ¥é›†é‡Œæ˜¯O(1)çš„ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦å°±æ˜¯ O(k)ã€‚
 * ç»¼åˆèµ·æ¥ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(m*n) + O(k)ã€‚
 *
 * @param {number} m è¡Œæ•°
 * @param {number} n åˆ—æ•°
 * @param {number[][]} positions æ¯ä¸€æ¬¡ç©ºé™é™†åœ°çš„ä½ç½®ï¼Œå½¢æˆä¸€ä¸ªåˆ—è¡¨
 * @returns {number[]} æ¯ä¸€æ­¥å½¢æˆçš„å²›å±¿æ•°é‡
*/
function numIslands21(m, n, positions) {
  // æ•°ç»„å®ç°çš„å¹¶æŸ¥é›†
  class UnionFind {
    constructor(m,n) {
      this.row = m;
      this.col = n;
      this.sets = 0;
      const len = this.row * this.col;  // å…ƒç´ æ€»æ•°é‡
      this.parent = Array(len).fill(len);  // Array<number> ç±»æ¯”parentMap
      // å¦‚æœ i è¦æŒ‚åˆ° j ä¸Šï¼Œé‚£ä¹ˆ:
      // size[j] += size[i] è¿™æ˜¯åŸæ¥çš„æ“ä½œï¼Œä¸å˜ã€‚
      // ä½†æ˜¯ size[i]=0 è¿™ä¸€æ­¥å°±åˆ«åšäº†ï¼Œå› ä¸ºæˆ‘ä»¬è¦è¿™æ ·ä¸€ä¸ªæœºåˆ¶: size[i]!=0 è¡¨ç¤º i è¢«åˆå§‹åŒ–è¿‡ï¼Œå¦‚æœ size[i]===0 è¡¨ç¤º i ä»æ¥æ²¡è¢«åˆå§‹åŒ–è¿‡ã€‚
      this.size = Array(len).fill(0);  // Array<number> æŸä¸ªé›†åˆçš„å¤§å°ï¼Œç”¨ä»£è¡¨ç»“ç‚¹çš„ç´¢å¼•ä¸º index, æ¯”å¦‚ this.size[2] = 6 å«ä¹‰æ˜¯ ä¸‹æ ‡2ç»“ç‚¹ä»£è¡¨çš„é›†åˆå¤§å°ä¸º6ã€‚
      this.help = Array(len).fill(0);  // Array<number>
    }
    
    // (i,j)ä½ç½®çš„ç‚¹ï¼Œåœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡
    getIndex(i,j) {
      return i * this.col + j;
    }
    
    // i æ˜¯ä¸‹æ ‡å€¼ï¼Œæ˜¯å¹¶æŸ¥é›†æ•°ç»„çš„ä½ç½®ï¼Œä¸æ˜¯çŸ©é˜µçš„ä½ç½®
    // æ‰¾åˆ° index ç»“ç‚¹çš„ä»£è¡¨ç»“ç‚¹çš„ç´¢å¼•ï¼Œè¿”å›
    find(i) {
      let hi = 0;
      // iä¸€ç›´å¾€çˆ¶ç»“ç‚¹ä¸Šç§»åŠ¨ï¼Œç›´åˆ°æ‰¾åˆ°ä»£è¡¨ç»“ç‚¹
      while (i != this.parent[i]) {
        this.help[hi++] = i;
        i = this.parent[i];
      }
      // æå‡æ€§èƒ½ğŸ”¥
      // iå¾€ä¸Šçªœåˆ°ä»£è¡¨ç»“ç‚¹çš„æ²¿é€”ç»“ç‚¹ï¼Œç›´æ¥æŒ‚åˆ°ä»£è¡¨ç»“ç‚¹ä¸Š
      for (hi--; hi >= 0; hi--) {
        this.parent[this.help[hi]] = i;
      }
      // è¿”å›ä»£è¡¨ç»“ç‚¹çš„ç´¢å¼•
      return i;
    }
    
    /**
     * æ£€æŸ¥ (r1,c1) å’Œ (r2,c2)ï¼Œå¦‚æœä¸¤ä¸ªç‚¹éƒ½æ˜¯`1`ï¼Œå°±å°†è¿™ä¸¤ä¸ªé›†åˆåˆå¹¶ï¼Œå«ä¹‰å°±æ˜¯æŠŠä¸¤ä¸ª`1`è¿èµ·æ¥ã€‚
     *
     * @param {number} r1 çŸ©é˜µç¬¬1ç‚¹çš„æ¨ªåæ ‡
     * @param {number} c1 çŸ©é˜µç¬¬1ç‚¹çš„çºµåæ ‡
     * @param {number} r2 çŸ©é˜µç¬¬2ç‚¹çš„æ¨ªåæ ‡
     * @param {number} c2 çŸ©é˜µç¬¬2ç‚¹çš„çºµåæ ‡
     */
    union(r1, c1, r2, c2) {
      // è¶Šç•Œæ£€æŸ¥
      if (r1 < 0 || r1 >= this.row || r2 < 0 || r2 >= this.row || c1 < 0 || c1 >= this.col || c2 < 0 || c2 >= this.col) {
        return;
      }
      // ç®—å‡º (r1,c1) å’Œ (r2,c2) çš„ä¸‹æ ‡
      const i1 = this.getIndex(r1,c1);
      const i2 = this.getIndex(r2,c2);
      if (this.size[i1] === 0 || this.size[i2] === 0) {
        // ä»»æ„ä¸€ä¸ªæ˜¯ 0 å°±ä¸èƒ½è¿ï¼Œå¿…é¡»ä¸¤ä¸ªéƒ½æ˜¯ 1 æ‰è¡Œã€‚
        return;
      }
      // æ‰¾åˆ°å„è‡ªä»£è¡¨ç»“ç‚¹çš„ç´¢å¼•
      const f1 = this.find(i1);
      const f2 = this.find(i2);
      // å¦‚æœä»£è¡¨ç»“ç‚¹ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰åˆå¹¶
      if (f1 !== f2) {
        // å°é›†åˆå»æŒ‚ä¸Šå¤§é›†åˆ, å°é›†åˆçš„é¦–æŒ‡é’ˆè¿ä¸Šå¤§é›†åˆçš„å¤´
        if (this.size[f1] >= this.size[f2]) {
          this.size[f1] += this.size[f2];
          this.parent[f2] = f1;
        } else {
          this.size[f2] += this.size[f1];
          this.parent[f1] = f2;
        }
        // ä¸¤ä¸ªé›†åˆåˆæˆä¸€ä¸ªï¼Œæ‰€ä»¥é›†åˆæ•°é‡-1
        this.sets--;
      }
    }
    
    /**
     * è·å–é›†åˆçš„æ•°é‡
     * @returns {number} é›†åˆæ•°é‡
     */
    getSetSize() {
      return this.sets;
    }
  
    /**
     * (i,j) ä¸Šæ¥äº†ä¸ª`1`, æ­¥éª¤:
     *    1. æŠŠå°é›†åˆå»ºå‡ºæ¥
     *    2. ä¸Šä¸‹å·¦å³è¿
     *    3. è¿”å›å…¨å±€çš„é›†åˆæ•°
     *
     * @param {number} i æ¨ªåæ ‡
     * @param {number} j çºµåæ ‡
     */
    connect(i, j) {
      // ç®—å‡ºè¯¥åæ ‡ç‚¹åœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡
      const index = this.getIndex(i,j);
      // this.size[index]===1 è¡¨ç¤ºè¿™ä¸ªä½ç½®å·²ç»æœ‰è¿‡1äº†ï¼Œé‚£å°±ä¸ç”¨å†å¤„ç†äº†ï¼Œ
      // æ¯”å¦‚ (5,3), (5,3), (5,3) å¤šæ¬¡å‡ºç°ï¼Œåªæœ‰ç¬¬ 1 æ¬¡æœ‰æ•ˆï¼Œåé¢çš„è¡Œä¸ºéƒ½æ˜¯ä¸ç”¨å¤„ç†çš„ã€‚
      if (this.size[index] === 0) {
        // ç©ºé™çš„`1`ä»æ¥æ²¡æœ‰å‡ºç°è¿‡ï¼Œé‚£ä¹ˆ`ç°åœºå»ºç«‹é›†åˆ`
        // è¯¥é›†åˆçš„çˆ¶å°±æ˜¯è‡ªå·±
        this.parent[index] = index;
        // é›†åˆåªæœ‰ 1 ç»“ç‚¹ï¼Œæ‰€ä»¥å¤§å°æ˜¯ 1
        this.size[index] = 1;
        // å•ç‹¬æˆ 1 ä¸ªé›†åˆï¼Œæ‰€ä»¥æ€»é›†åˆåŠ  1 ä¸ª
        this.sets++;
        // ä¸Šä¸‹å·¦å³ï¼Œèƒ½è¿å°±è¿èµ·æ¥
        this.union(i-1, j, i, j);
        this.union(i+1, j, i, j);
        this.union(i, j-1, i, j);
        this.union(i, j+1, i, j);
      }
      // è¿”å›é›†åˆæ•°é‡ï¼Œå³`è¿æˆä¸€ç‰‡çš„1çš„æ•°é‡`ï¼Œåœ¨é¢˜ç›®é‡Œå°±æ˜¯å²›å±¿çš„æ•°é‡ã€‚
      return this.sets;
    }
  }
  
  const uf = new UnionFind(m,n);
  const ans = [];  // Array<number> å­˜æ”¾æ¯ä¸€æ¬¡ç©ºé™å½¢æˆçš„å²›å±¿æ•°é‡
  
  for (let i = 0, len = positions.length; i < len; i++) {
    // 1.æ¯ä¸€æ­¥ç©ºé™çš„é™†åœ°ï¼Œéƒ½åœ¨å¹¶æŸ¥é›†é‡Œ`è¿æ¥`ä¸€ä¸‹ï¼Œè¿å®Œå¹¶æŸ¥é›†èƒ½ç«‹å³æŸ¥åˆ°é›†åˆæ•°é‡ï¼Œä¹Ÿå°±æ˜¯`å²›å±¿æ•°é‡`
    // 2.æŠŠå²›å±¿æ•°é‡éƒ½åŠ åˆ°æ•°ç»„é‡Œ
    const ps = positions[i];
    ans.push(uf.connect(ps[0], ps[1]));
  }
  
  return ans;
}
